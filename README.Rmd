---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->
<!-- use devtools::build_readme() -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  warning = FALSE,
  message = FALSE,
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# omopcepts

<!-- badges: start -->
<!-- badges: end -->

omopcepts provides access to a subset of **OMOP** con**cepts** and flexible tidyverse compatible R functions for querying.    

The [OMOP Common Data Model](https://ohdsi.github.io/CommonDataModel/) is an open standard for health data. "[It is] designed to standardize the structure and content of observational data and to enable efficient analyses that can produce reliable evidence".    
    
OMOP is maintained by OHDSI (pronounced "Odyssey"). "The Observational Health Data Sciences and Informatics  program is a multi-stakeholder, interdisciplinary collaborative that strives to improve medical decision making and bring better health outcomes to patients around the world."    
    
OMOP concepts can be searched and downloaded from [Athena â€“ the  OHDSI vocabularies repository](https://athena.ohdsi.org).    
    
This package provides R tools to interact with the concepts in a more reproducible way.

## Installation

Install the development version of omopcepts with:

``` r
# install.packages("remotes")

remotes::install_github("andysouth/omopcepts")

```


## Main functions

```omop_names() onames()```     search concepts by parts of names     
     
```omop_id() oid()```           search for a concept_id     
     
```omop_join_names()```         join names onto a table with an id column         


## Concept data

OMOP vocab data downloaded from Athena includes a table called CONCEPT.csv that is used in this package.     
     
omopcepts downloads a selection of vocabularies and stores locally the first time you use it.


```{r concept table, echo=FALSE}

library(omopcepts)

fieldnames <- omop_concept() |> 
  head() |> 
  names()

df1 <- data.frame(fields=fieldnames,
                  about=c("unique id","descriptive name","e.g. drug, measurement","e.g. LOINC, SNOMED","e.g. Clinical Observation, Organism","standard or not","source code","","",""),
                  query_arguments=c("c_ids","pattern","d_ids","v_ids","cc_ids","standard","","","","")
                  )

knitr::kable(df1)
```

## String search in concept_name field

```{r omop_names, echo=TRUE}

omop_names("chemotherapy", v_ids="LOINC")

omop_names("chemotherapy", v_ids=c("LOINC","SNOMED"), d_ids=c("Observation","Procedure"))

```

## Join OMOP names onto a dataframe containing concept ids in a column called *concept_id

Helps to interpret OMOP data.

```{r omop_join_name, echo=TRUE}


data.frame(concept_id=(c(3571338L,4002075L))) |> 
  omop_join_name()
 

data.frame(drug_concept_id=(c(4000794L,4002592L))) |> 
  omop_join_name(namestart="drug")


```


## Vocabularies included

The vocabularies are a default download from Athena with a few extra vocabs added. 
Later we may offer option to add other vocabularies.


### Numbers of concepts in the package by domain and vocabulary

```{r conceptplot, echo = TRUE, fig.height=12}
library(dplyr)
library(ggplot2)
library(forcats)

concept_summary <- 
  omop_concept() |>
  count(vocabulary_id, sort=TRUE) |> 
  collect()

ggplot(concept_summary,aes(y=reorder(vocabulary_id,n),x=n,col=vocabulary_id)) +
  geom_point() +
  labs(y = "vocabulary_id") +
  guides(col="none") +
  theme_minimal()


```

